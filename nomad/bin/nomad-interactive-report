#!/usr/bin/env python3
"""
Standalone interactive session report for Python 3.6+
Usage: nomade-interactive-report [--quiet] [--json]
"""
import sys
import os

# Direct import to avoid loading framework
script_dir = os.path.dirname(os.path.abspath(__file__))
nomade_dir = os.path.dirname(script_dir)
sys.path.insert(0, nomade_dir)

# Import directly from file, not package
import importlib.util
spec = importlib.util.spec_from_file_location(
    "interactive", 
    os.path.join(nomade_dir, "collectors", "interactive.py")
)
interactive = importlib.util.module_from_spec(spec)

# Mock the framework imports before loading
sys.modules['nomade'] = type(sys)('nomade')
sys.modules['nomade.collectors'] = type(sys)('nomade.collectors')
sys.modules['nomade.collectors.base'] = type(sys)('nomade.collectors.base')

# Create dummy BaseCollector and registry
class DummyBase:
    pass

class DummyRegistry:
    def register(self, cls):
        return cls

sys.modules['nomade.collectors.base'].BaseCollector = DummyBase
sys.modules['nomade.collectors.base'].registry = DummyRegistry()

spec.loader.exec_module(interactive)

def main():
    quiet = '--quiet' in sys.argv or '-q' in sys.argv
    as_json = '--json' in sys.argv
    
    data = interactive.get_report()
    
    if as_json:
        import json
        print(json.dumps(data, indent=2))
        return
    
    if quiet:
        alerts = data.get('alerts', {})
        has_alerts = False
        
        if alerts.get('idle_session_hogs'):
            has_alerts = True
            print("[!] Users with >5 idle sessions:")
            for u in alerts['idle_session_hogs']:
                print("    {}: {} idle ({} RStudio, {} Jupyter), {:.0f} MB".format(
                    u['user'], u['idle'], u['rstudio'], u['jupyter'], u['memory_mb']))
        
        if alerts.get('stale_sessions'):
            has_alerts = True
            print("\n[!] Stale sessions (idle >24h): {}".format(len(alerts['stale_sessions'])))
            for s in alerts['stale_sessions'][:10]:
                print("    {}: {}, {:.0f}h old, {:.0f} MB".format(
                    s['user'], s['session_type'], s['age_hours'], s['mem_mb']))
        
        if alerts.get('memory_hogs'):
            has_alerts = True
            print("\n[!] Memory hogs (>4GB): {}".format(len(alerts['memory_hogs'])))
            for s in alerts['memory_hogs'][:10]:
                print("    {}: {}, {:.1f} GB".format(
                    s['user'], s['session_type'], s['mem_mb']/1024))
        
        if not has_alerts:
            print("No alerts - all sessions within thresholds")
        return
    
    interactive.print_report(data)

if __name__ == '__main__':
    main()
